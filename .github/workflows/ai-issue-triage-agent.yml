name: "AI Issue Triage (B: Code Agent)"

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to triage'
        required: true
        type: number

jobs:
  ai-triage-agent:
    if: github.event_name == 'workflow_dispatch' || github.event.label.name == 'needs triage'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      models: read
      contents: read

    env:
      SUPPRESS_LABELS: 'true'
      SUPPRESS_COMMENTS: 'false'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number || ${{ inputs.issue_number || 0 }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const { data: issue } = await github.rest.issues.get({
              owner, repo, issue_number: issueNumber,
            });

            const hasAiLabels = issue.labels.some(l => l.name.startsWith('ai:'));
            const { data: comments } = await github.rest.issues.listComments({
              owner, repo, issue_number: issueNumber, per_page: 100,
            });
            const hasAiComment = comments.some(c =>
              c.body && c.body.includes('### AI Assessment:')
            );

            const isRetriage = hasAiLabels || hasAiComment;
            let issueBody = issue.body || '';

            if (isRetriage) {
              const lastAiIdx = comments.reduce((acc, c, i) =>
                c.body && c.body.includes('### AI Assessment:') ? i : acc, -1);

              const authorReplies = comments
                .slice(lastAiIdx + 1)
                .filter(c => c.user.login === issue.user.login)
                .map(c => c.body)
                .join('\n\n---\n\n');

              if (authorReplies) {
                issueBody = `[RE-TRIAGE] The author has provided additional information in response to a prior AI assessment.\n\n`
                  + `## Original Issue Summary\n${issue.title}\n\n`
                  + `## Author's Follow-up Response\n${authorReplies}\n\n`
                  + `Focus your assessment on the new information provided above. Reference the original issue only if needed for context.`;
              }
            }

            core.setOutput('number', issue.number);
            core.setOutput('body', issueBody);
            core.setOutput('title', issue.title);
            core.setOutput('html_url', issue.html_url);
            core.setOutput('labels', issue.labels.map(l => l.name).join(','));
            core.setOutput('author', issue.user.login);

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install triage dependencies
        run: pip install requests pyyaml

      - name: Run AI triage agent
        id: ai-assessment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_BODY: ${{ steps.issue.outputs.body }}
          ISSUE_LABELS: ${{ steps.issue.outputs.labels }}
          ISSUE_AUTHOR: ${{ steps.issue.outputs.author }}
          AI_TRIAGE_MODEL: 'openai/gpt-4.1'
          AI_TRIAGE_MAX_TOKENS: '1500'
        run: python scripts/ai_triage.py

      - name: Apply AI label
        if: steps.ai-assessment.outputs.assessment != '' && env.SUPPRESS_LABELS != 'true'
        uses: actions/github-script@v7
        env:
          ASSESSMENT: ${{ steps.ai-assessment.outputs.assessment }}
          PROMPT_NAME: ${{ steps.ai-assessment.outputs.prompt_name }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const promptName = process.env.PROMPT_NAME;
            const assessment = process.env.ASSESSMENT;
            const labelName = `ai:${promptName}:${assessment.toLowerCase().replace(/\s+/g, ' ')}`;

            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner, repo, issue_number: issueNumber,
            });
            for (const l of currentLabels) {
              if (l.name.startsWith(`ai:${promptName}:`)) {
                try {
                  await github.rest.issues.removeLabel({
                    owner, repo, issue_number: issueNumber, name: l.name,
                  });
                } catch (_) {}
              }
            }

            await github.rest.issues.addLabels({
              owner, repo, issue_number: issueNumber, labels: [labelName],
            });

      - name: Post-process triage results
        if: steps.ai-assessment.outputs.assessment != ''
        uses: actions/github-script@v7
        env:
          ASSESSMENT: ${{ steps.ai-assessment.outputs.assessment }}
          SUPPRESS_LABELS: ${{ env.SUPPRESS_LABELS }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const assessment = (process.env.ASSESSMENT || '').toLowerCase();
            const issueNumber = parseInt(process.env.ISSUE_NUMBER);
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const suppressLabels = process.env.SUPPRESS_LABELS === 'true';

            const needsHumanReview = assessment.includes('needs team review')
              || assessment.includes('needs maintainer input')
              || assessment.includes('potential bug');
            const addHelpWanted = assessment.includes('help wanted');
            const needsAuthorFeedback = assessment.includes('needs author feedback')
              || assessment.includes('requires additional details');
            const canAutoClose = assessment.includes('answered')
              || assessment.includes('likely misconfiguration')
              || assessment.includes('redirect to docs');

            core.info(`Assessment: ${process.env.ASSESSMENT}, needsHumanReview=${needsHumanReview}`);

            if (suppressLabels) {
              core.info('Labels suppressed ‚Äî logging decisions only.');
              core.exportVariable('LABEL_DECISIONS', JSON.stringify({
                needsHumanReview, addHelpWanted, needsAuthorFeedback, canAutoClose,
                assessmentLabel: process.env.ASSESSMENT,
              }));
              return;
            }

            if (addHelpWanted) {
              await github.rest.issues.addLabels({
                owner, repo, issue_number: issueNumber, labels: ['help wanted'],
              });
            }

            if (!needsHumanReview) {
              try {
                await github.rest.issues.removeLabel({
                  owner, repo, issue_number: issueNumber, name: 'needs triage',
                });
              } catch (e) {
                core.info(`Could not remove "needs triage": ${e.message}`);
              }

              if (canAutoClose && !needsAuthorFeedback && !addHelpWanted) {
                await github.rest.issues.update({
                  owner, repo, issue_number: issueNumber,
                  state: 'closed', state_reason: 'completed',
                });
              }
            } else {
              await github.rest.issues.addLabels({
                owner, repo, issue_number: issueNumber, labels: ['ai:needs team attention'],
              });
              await github.rest.issues.createComment({
                owner, repo, issue_number: issueNumber,
                body: 'üîî @microsoft/fabric-cli-dev ‚Äî This issue has been flagged by AI triage as requiring team attention.',
              });
            }

      - name: Post tagged comment
        if: steps.ai-assessment.outputs.response != ''
        uses: actions/github-script@v7
        env:
          RESPONSE: ${{ steps.ai-assessment.outputs.response }}
          ASSESSMENT: ${{ steps.ai-assessment.outputs.assessment }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          LABEL_DECISIONS: ${{ env.LABEL_DECISIONS }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = process.env.RESPONSE;
            const assessment = process.env.ASSESSMENT;
            const ld = process.env.LABEL_DECISIONS ? JSON.parse(process.env.LABEL_DECISIONS) : null;

            let body = '> üÖ±Ô∏è **Approach B (Code Agent)** ‚Äî code-aware triage agent that reads the actual source code\n\n';
            body += response + '\n\n';

            body += `---\n`;
            body += `<details><summary>üè∑Ô∏è Label Decisions (testing mode ‚Äî not applied)</summary>\n\n`;
            body += `| Decision | Value |\n|----------|-------|\n`;
            if (ld) {
              body += `| AI assessment | \`${ld.assessmentLabel}\` |\n`;
              body += `| Would add \`help wanted\` | ${ld.addHelpWanted ? '‚úÖ' : '‚ùå'} |\n`;
              body += `| Would add \`ai:needs team attention\` | ${ld.needsHumanReview ? '‚úÖ' : '‚ùå'} |\n`;
              body += `| Would request author feedback | ${ld.needsAuthorFeedback ? '‚úÖ' : '‚ùå'} |\n`;
              body += `| Would remove \`needs triage\` | ${!ld.needsHumanReview ? '‚úÖ' : '‚ùå'} |\n`;
              body += `| Would auto-close | ${ld.canAutoClose && !ld.needsAuthorFeedback && !ld.addHelpWanted ? '‚úÖ' : '‚ùå'} |\n`;
              body += `| Would notify team | ${ld.needsHumanReview ? '‚úÖ' : '‚ùå'} |\n`;
            } else {
              body += `| AI assessment | \`${assessment}\` |\n`;
            }
            body += `\n</details>\n`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(process.env.ISSUE_NUMBER),
              body,
            });

      - name: Generate triage summary
        if: always() && steps.ai-assessment.outputs.assessment != ''
        uses: actions/github-script@v7
        env:
          ASSESSMENT: ${{ steps.ai-assessment.outputs.assessment }}
          PROMPT_NAME: ${{ steps.ai-assessment.outputs.prompt_name }}
          RESPONSE: ${{ steps.ai-assessment.outputs.response }}
          LABEL_DECISIONS: ${{ env.LABEL_DECISIONS }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_URL: ${{ steps.issue.outputs.html_url }}
        with:
          script: |
            const issueNumber = process.env.ISSUE_NUMBER;
            const issueTitle = process.env.ISSUE_TITLE;
            const issueUrl = process.env.ISSUE_URL;
            const promptName = process.env.PROMPT_NAME;
            const assessment = process.env.ASSESSMENT;
            const response = process.env.RESPONSE;

            let summary = `## ü§ñ AI Triage Report (Approach B: Code Agent)\n\n`;
            summary += `**Issue:** [#${issueNumber} ‚Äî ${issueTitle}](${issueUrl})\n\n`;
            summary += `### Prompt: \`${promptName}\`\n`;
            summary += `**Assessment:** \`${assessment}\`\n\n`;
            summary += `<details><summary>Full AI Response</summary>\n\n`;
            summary += `${response}\n\n`;
            summary += `</details>\n\n`;

            const ld = process.env.LABEL_DECISIONS ? JSON.parse(process.env.LABEL_DECISIONS) : null;
            if (ld) {
              summary += `### üè∑Ô∏è Label Decisions (not applied ‚Äî testing mode)\n\n`;
              summary += `| Decision | Value |\n|----------|-------|\n`;
              summary += `| AI assessment label | \`${ld.assessmentLabel}\` |\n`;
              summary += `| Would add \`help wanted\` | ${ld.addHelpWanted ? '‚úÖ Yes' : '‚ùå No'} |\n`;
              summary += `| Would add \`ai:needs team attention\` | ${ld.needsHumanReview ? '‚úÖ Yes' : '‚ùå No'} |\n`;
              summary += `| Would request author feedback | ${ld.needsAuthorFeedback ? '‚úÖ Yes' : '‚ùå No'} |\n`;
              summary += `| Would remove \`needs triage\` | ${!ld.needsHumanReview ? '‚úÖ Yes' : '‚ùå No'} |\n`;
              summary += `| Would auto-close | ${ld.canAutoClose && !ld.needsAuthorFeedback && !ld.addHelpWanted ? '‚úÖ Yes' : '‚ùå No'} |\n`;
              summary += `| Would notify team | ${ld.needsHumanReview ? '‚úÖ Yes' : '‚ùå No'} |\n\n`;
            }

            summary += `---\n\n`;

            core.summary.addRaw(summary);
            await core.summary.write();

            const fs = require('fs');
            fs.mkdirSync('triage-reports', { recursive: true });
            fs.writeFileSync(
              `triage-reports/issue-${issueNumber}-triage-agent.md`,
              summary
            );

      - name: Upload triage report
        if: always() && steps.ai-assessment.outputs.assessment != ''
        uses: actions/upload-artifact@v4
        with:
          name: triage-report-agent-issue-${{ steps.issue.outputs.number }}
          path: triage-reports/
          retention-days: 30
